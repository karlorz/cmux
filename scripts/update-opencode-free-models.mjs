#!/usr/bin/env node

// Discover OpenCode models that respond without authentication and write them
// to packages/shared/src/providers/opencode/free-models.generated.ts

import { writeFile } from "node:fs/promises";

const MODELS_URL = "https://opencode.ai/zen/v1/models";
const CHAT_COMPLETIONS_URL = "https://opencode.ai/zen/v1/chat/completions";
const OUTPUT_PATH =
  "packages/shared/src/providers/opencode/free-models.generated.ts";

async function fetchModelIds() {
  const response = await fetch(MODELS_URL);
  if (!response.ok) {
    throw new Error(
      `Failed to load model list: HTTP ${response.status} ${response.statusText}`
    );
  }

  const payload = await response.json();
  const ids =
    payload?.data?.map((entry) => entry?.id).filter(Boolean) ?? [];

  if (ids.length === 0) {
    throw new Error("No model ids returned from OpenCode");
  }

  return ids;
}

async function probeModel(modelId) {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 8000);

  try {
    const response = await fetch(CHAT_COMPLETIONS_URL, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({
        model: modelId,
        messages: [{ role: "user", content: "ping" }],
        max_tokens: 1,
      }),
      signal: controller.signal,
    });

    if (!response.ok) {
      return { modelId, free: false, status: response.status };
    }

    const data = await response.json();
    const isFree = Array.isArray(data?.choices);
    return {
      modelId,
      free: isFree,
      status: response.status,
      sample: isFree ? data?.choices?.[0]?.message?.content : undefined,
    };
  } catch (error) {
    return {
      modelId,
      free: false,
      status: "error",
      error: error instanceof Error ? error.message : String(error),
    };
  } finally {
    clearTimeout(timeout);
  }
}

async function main() {
  const modelIds = await fetchModelIds();
  const results = [];

  // Probe sequentially to avoid spamming the endpoint
  for (const modelId of modelIds) {
    // eslint-disable-next-line no-await-in-loop
    const result = await probeModel(modelId);
    const state = result.free ? "free" : "locked";
    const status = result.status ?? "unknown";
    console.log(`[${state}] ${modelId} (status: ${status})`);
    results.push(result);
  }

  const freeModels = results
    .filter((entry) => entry.free)
    .map((entry) => entry.modelId)
    .sort((a, b) => a.localeCompare(b));

  const banner = [
    "// Auto-generated by scripts/update-opencode-free-models.mjs",
    `// Source: ${MODELS_URL}`,
    `// Last updated: ${new Date().toISOString()}`,
    "",
  ].join("\n");

  const output = `${banner}export const OPENCODE_FREE_MODEL_IDS = ${JSON.stringify(
    freeModels,
    null,
    2
  )} as const;

export type OpencodeFreeModelId = typeof OPENCODE_FREE_MODEL_IDS[number];
`;

  await writeFile(OUTPUT_PATH, output);
  console.log(
    `Wrote ${freeModels.length} free models to ${OUTPUT_PATH}`
  );
}

main().catch((error) => {
  console.error(error);
  process.exit(1);
});
