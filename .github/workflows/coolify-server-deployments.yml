name: Coolify (cmux-server)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

concurrency:
  group: coolify-cmux-server-${{ github.ref }}
  cancel-in-progress: false

jobs:
  report-deployment:
    name: Report deploy status
    runs-on: ubuntu-24.04
    timeout-minutes: 35
    env:
      RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
      ENVIRONMENT_NAME: Production â€“ cmux-server

    steps:
      - name: Create GitHub deployment
        id: gh_deployment
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const ref = context.sha;
            const runUrl = process.env.RUN_URL;
            const environment = process.env.ENVIRONMENT_NAME;

            const deployment = await github.rest.repos.createDeployment({
              owner,
              repo,
              ref,
              environment,
              auto_merge: false,
              required_contexts: [],
              description: `Coolify deploy for ${ref}`,
              transient_environment: false,
              production_environment: true,
            });

            core.setOutput("deployment_id", deployment.data.id);

            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id: deployment.data.id,
              state: "in_progress",
              log_url: runUrl,
              description: "Waiting for Coolify deployment",
            });

      - name: Wait for Coolify deployment
        id: coolify
        shell: bash
        env:
          COOLIFY_BASE_URL: ${{ secrets.COOLIFY_BASE_URL }}
          COOLIFY_API_TOKEN: ${{ secrets.COOLIFY_API_TOKEN }}
          COOLIFY_APP_UUID: ${{ secrets.COOLIFY_APP_UUID }}
          COOLIFY_ENV_URL: ${{ secrets.COOLIFY_ENV_URL }}
        run: |
          set -euo pipefail

          if [[ -z "${COOLIFY_BASE_URL:-}" ]]; then
            echo "Missing required secret: COOLIFY_BASE_URL" >&2
            exit 1
          fi
          if [[ -z "${COOLIFY_API_TOKEN:-}" ]]; then
            echo "Missing required secret: COOLIFY_API_TOKEN" >&2
            exit 1
          fi
          if [[ -z "${COOLIFY_APP_UUID:-}" ]]; then
            echo "Missing required secret: COOLIFY_APP_UUID" >&2
            exit 1
          fi

          base_url="${COOLIFY_BASE_URL%/}"
          sha="${GITHUB_SHA}"
          sha7="${sha:0:7}"

          auth_header="Authorization: Bearer ${COOLIFY_API_TOKEN}"

          tmp_dir="$(mktemp -d)"
          cleanup() { rm -rf "$tmp_dir"; }
          trap cleanup EXIT

          poll_interval_seconds=10
          find_timeout_seconds=$((5 * 60))
          deploy_timeout_seconds=$((30 * 60))

          now_epoch() { date +%s; }

          http_get_json() {
            local url="$1"
            local out_file="$2"
            local code
            code="$(curl -sS -o "$out_file" -w '%{http_code}' \
              --connect-timeout 10 --max-time 30 --retry 3 --retry-delay 1 \
              -H "Accept: application/json" -H "$auth_header" \
              "$url" || true)"
            echo "$code"
          }

          find_deployment_uuid() {
            local start_epoch="$1"
            local deadline=$((start_epoch + find_timeout_seconds))
            local resp="$tmp_dir/resp.json"
            local dep_uuid
            local code
            local url

            while (( $(now_epoch) < deadline )); do
              for url in \
                "${base_url}/api/v1/deployments/applications/${COOLIFY_APP_UUID}?skip=0&take=20" \
                "${base_url}/api/v1/deployments/applications/${COOLIFY_APP_UUID}" \
                "${base_url}/api/v1/applications/${COOLIFY_APP_UUID}/deployments?skip=0&take=20" \
                "${base_url}/api/v1/applications/${COOLIFY_APP_UUID}/deployments" \
              ; do
                code="$(http_get_json "$url" "$resp")"
                if [[ "$code" == "200" ]]; then
                  dep_uuid="$(jq -r --arg sha "$sha" --arg sha7 "$sha7" '
                    def matches_commit($c):
                      ($c != null) and ($c != "") and
                      (($sha | startswith($c)) or ($c | startswith($sha)) or ($sha7 | startswith($c)) or ($c | startswith($sha7)));

                    (if type=="array" then .
                     elif has("data") and (.data|type)=="array" then .data
                     elif has("deployments") and (.deployments|type)=="array" then .deployments
                     else [] end)
                    | map(select(matches_commit(.commit) or matches_commit(.git_commit_sha) or matches_commit(.git_commit_hash)))
                    | (.[0] // empty)
                    | (.deployment_uuid // .uuid // empty)
                  ' "$resp" 2>/dev/null || true)"
                  if [[ -n "${dep_uuid:-}" && "${dep_uuid:-null}" != "null" ]]; then
                    echo "$dep_uuid"
                    return 0
                  fi
                fi
              done

              code="$(http_get_json "${base_url}/api/v1/deployments" "$resp")"
              if [[ "$code" == "200" ]]; then
                dep_uuid="$(jq -r --arg sha "$sha" --arg sha7 "$sha7" '
                  def matches_commit($c):
                    ($c != null) and ($c != "") and
                    (($sha | startswith($c)) or ($c | startswith($sha)) or ($sha7 | startswith($c)) or ($c | startswith($sha7)));

                  (if type=="array" then . else [] end)
                  | map(select(matches_commit(.commit) or matches_commit(.git_commit_sha) or matches_commit(.git_commit_hash)))
                  | (.[0] // empty)
                  | (.deployment_uuid // .uuid // empty)
                ' "$resp" 2>/dev/null || true)"
                if [[ -n "${dep_uuid:-}" && "${dep_uuid:-null}" != "null" ]]; then
                  echo "$dep_uuid"
                  return 0
                fi
              fi

              sleep "$poll_interval_seconds"
            done

            return 1
          }

          normalize_status() {
            local raw="$1"
            raw="$(echo "$raw" | tr '[:upper:]' '[:lower:]')"
            case "$raw" in
              success|succeeded|finished|completed) echo "success" ;;
              failed|failure|error|errored|cancelled|canceled) echo "failure" ;;
              running|queued|in_progress|in-progress|pending) echo "running" ;;
              *) echo "$raw" ;;
            esac
          }

          echo "Looking for Coolify deployment for commit ${sha7}..." >&2
          start_epoch="$(now_epoch)"
          deployment_uuid="$(find_deployment_uuid "$start_epoch" || true)"

          if [[ -z "${deployment_uuid:-}" ]]; then
            echo "conclusion=failure" >> "$GITHUB_OUTPUT"
            echo "coolify_status=no_deployment_found" >> "$GITHUB_OUTPUT"
            echo "deployment_url=${COOLIFY_ENV_URL:-}" >> "$GITHUB_OUTPUT"
            echo "No Coolify deployment detected for SHA ${sha}." >&2
            exit 1
          fi

          echo "Found Coolify deployment UUID: ${deployment_uuid}" >&2

          detail_url="${base_url}/api/v1/deployments/${deployment_uuid}"
          resp="$tmp_dir/detail.json"
          deadline=$((start_epoch + deploy_timeout_seconds))

          while (( $(now_epoch) < deadline )); do
            code="$(http_get_json "$detail_url" "$resp")"
            if [[ "$code" != "200" ]]; then
              echo "Coolify API returned HTTP ${code} for ${detail_url}, retrying..." >&2
              sleep "$poll_interval_seconds"
              continue
            fi

            raw_status="$(jq -r '.status // empty' "$resp" 2>/dev/null || true)"
            norm_status="$(normalize_status "${raw_status:-unknown}")"

            deployment_url="$(jq -r '.deployment_url // empty' "$resp" 2>/dev/null || true)"
            if [[ -z "${deployment_url:-}" && -n "${COOLIFY_ENV_URL:-}" ]]; then
              deployment_url="${COOLIFY_ENV_URL}"
            fi

            echo "coolify_status=${raw_status:-unknown}" >> "$GITHUB_OUTPUT"
            echo "deployment_url=${deployment_url:-}" >> "$GITHUB_OUTPUT"

            if [[ "$norm_status" == "success" ]]; then
              echo "conclusion=success" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            if [[ "$norm_status" == "failure" ]]; then
              echo "conclusion=failure" >> "$GITHUB_OUTPUT"
              echo "Coolify deployment failed (status: ${raw_status})." >&2

              logs="$(jq -r '.logs // empty' "$resp" 2>/dev/null || true)"
              if [[ -n "${logs:-}" ]]; then
                echo "---- Coolify logs (tail) ----" >&2
                echo "$logs" | tail -n 200 >&2 || true
                echo "-----------------------------" >&2
              fi

              exit 1
            fi

            echo "Coolify deployment status: ${raw_status:-unknown} (waiting...)" >&2
            sleep "$poll_interval_seconds"
          done

          echo "conclusion=failure" >> "$GITHUB_OUTPUT"
          echo "coolify_status=timeout" >> "$GITHUB_OUTPUT"
          echo "deployment_url=${COOLIFY_ENV_URL:-}" >> "$GITHUB_OUTPUT"
          echo "Timed out waiting for Coolify deployment ${deployment_uuid}." >&2
          exit 1

      - name: Update GitHub deployment status
        if: always()
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_ID: ${{ steps.gh_deployment.outputs.deployment_id }}
          CONCLUSION: ${{ steps.coolify.outputs.conclusion }}
          ENVIRONMENT_URL: ${{ steps.coolify.outputs.deployment_url }}
          COOLIFY_STATUS: ${{ steps.coolify.outputs.coolify_status }}
        with:
          script: |
            const deploymentIdRaw = process.env.DEPLOYMENT_ID;
            if (!deploymentIdRaw) {
              core.warning("No GitHub deployment id found. Skipping deployment status update.");
              return;
            }

            const { owner, repo } = context.repo;
            const deploymentId = Number(deploymentIdRaw);
            const runUrl = process.env.RUN_URL;
            const conclusion = process.env.CONCLUSION || "failure";
            const envUrl = process.env.ENVIRONMENT_URL || undefined;
            const coolifyStatus = process.env.COOLIFY_STATUS || "unknown";

            const state = conclusion === "success" ? "success" : "failure";
            const description =
              state === "success"
                ? "Coolify deployment succeeded"
                : `Coolify deployment failed (${coolifyStatus})`;

            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id: deploymentId,
              state,
              log_url: runUrl,
              environment_url: envUrl,
              description,
            });
