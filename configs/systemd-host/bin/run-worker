#!/usr/bin/env bash
set -euo pipefail

CMUX_HOME="${CMUX_HOME:-/opt/cmux}"
CMUX_WORKER_PORT="${CMUX_WORKER_PORT:-39377}"
WORKER_PORT="${WORKER_PORT:-${CMUX_WORKER_PORT}}"

export HOME="${CMUX_HOME}"
export CMUX_HOME
export CMUX_WORKER_PORT="${CMUX_WORKER_PORT}"
export WORKER_PORT
export NODE_ENV="${NODE_ENV:-production}"
export IS_SANDBOX="${IS_SANDBOX:-true}"
export NODE_PATH="${CMUX_HOME}/builtins/build/node_modules${NODE_PATH:+:${NODE_PATH}}"

mkdir -p "${CMUX_HOME}/workspace" /var/log/cmux

WORKER_RUNTIME_BIN="${CMUX_WORKER_RUNTIME_BIN:-}"
if [[ -z "${WORKER_RUNTIME_BIN}" ]]; then
  if command -v cmux-worker-runtime >/dev/null 2>&1; then
    WORKER_RUNTIME_BIN="$(command -v cmux-worker-runtime)"
  else
    WORKER_RUNTIME_BIN="$(command -v node || true)"
  fi
fi

if [[ -z "${WORKER_RUNTIME_BIN}" ]]; then
  echo "cmux worker runtime not found" >&2
  exit 1
fi

exec "${WORKER_RUNTIME_BIN}" "${CMUX_HOME}/builtins/build/index.js"
